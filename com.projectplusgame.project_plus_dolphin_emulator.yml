app-id: com.projectplusgame.project_plus_dolphin_emulator
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: ishiiruka-wrapper
rename-desktop-file: faster-project-plus.desktop
rename-icon: ishiiruka
finish-args:
  - --device=all
  # the file picker uses portals but the set
  # game directory feature still needs this
  - --filesystem=host:ro
  - --socket=pulseaudio
  - --env=QT_QPA_PLATFORM=xcb
  - --socket=x11
  - --share=network
  - --share=ipc
  # required for the emulated bluetooth adapter feature to work.
  - --allow=bluetooth
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --talk-name=org.freedesktop.ScreenSaver
  # required for Gamescope on Steam Deck
  - --filesystem=xdg-run/gamescope-0:ro
modules:
  - shared-modules/gtk2/gtk2.json
  - name: gtk2

  - shared-modules/libusb/libusb.json
  - name: libusb

  # enables motion controls on non-wii controllers (switch, ps4, etc)
  # requires a udev rule enabling Motion Sensors access
  - name: libevdev
    buildsystem: meson
    config-opts:
      - -Dtests=disabled
      - -Ddocumentation=disabled
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/libevdev/libevdev-1.13.1.tar.xz
        sha256: 06a77bf2ac5c993305882bc1641017f5bec1592d6d1b64787bad492ab34f2f36
        x-checker-data:
          type: anitya
          project-id: 20540
          stable-only: true
          url-template: https://www.freedesktop.org/software/libevdev/libevdev-$version.tar.xz

  # needed for screensaver inhibition
  - name: xdg-screensaver-shim
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/Unrud/xdg-screensaver-shim/archive/0.0.2.tar.gz
        sha256: 0ed2a69fe6ee6cbffd2fe16f85116db737f17fb1e79bfb812d893cf15c728399
        
  - name: ishiiruka
    buildsystem: cmake
    config-opts:
      # - -DLINUX_LOCAL_DEV=true # This flag makes Dolphin/Ishiiruka look for the Sys directory in the same directory as the binary and the repo we are pulling from places the Sys directory there by default (if this is turned off make sure the Sys directory is being moved to ${FLATPAK_DEST}/share/ishiiruka/sys instead)
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_SDL=ON
      - -DENABLE_EVDEV=ON
      - -DDISTRIBUTOR=Flathub
    cleanup:
      - /share/man
    sources:
      # Project Plus Ishiiruka/Dolphin emulator fork
      - type: git
        url: https://github.com/jlambert360/Ishiiruka.git
        commit: eec8c7fdfc62efd1555a9bc671cb48533fed439c

      # Move wx files into source
      - type: shell
        commands:
          - |
            echo "Moving wx files into source"
            cp Externals/wxWidgets3/include/wx Source/Core/ -r
            cp Externals/wxWidgets3/wx/* Source/Core/wx/

      # Copy gdkconfig.h from previously installed gtk2 above to an included directory otherwise making will complain about not being able to find either gdkconfig.h or gtk/gtk.h
      - type: shell
        commands:
          - |
            echo "Copying ${FLATPAK_DEST}/lib/gtk-2.0/include/gdkconfig.h to ${FLATPAK_DEST}/include/gtk-2.0/gdkconfig.h"
            cp ${FLATPAK_DEST}/lib/gtk-2.0/include/gdkconfig.h ${FLATPAK_DEST}/include/gtk-2.0/gdkconfig.h

      # Patches Source/Core/UICommon/UICommon.cpp to check if in a Flatpak sandbox and set data, config, and cache paths correctly
      - type: patch
        path: detectflatpak.patch

      # Patches Data/User/Config/Dolphin.ini to set proper paths, graphics backend and audio backend
      - type: patch
        path: dolphinini.patch

      # Project Plus SD card
      - type: file
        url: https://github.com/jlambert360/FPM-AppImage/releases/download/v2.5.2/sd.tar.gz
        sha256: 121d08f8fcbf2fc24d5b48481f387398f24be30de3eb66fb510cb9f5a67f4657 # This is the hash of the tar.gz file not the uncompressed

      # Project Plus .dol files and icon
      - type: archive
        url: https://github.com/jlambert360/FPM-AppImage/releases/download/v2.5.2/Launcher.tar.gz
        sha256: 1b9dce2fb0eac3ad8cc809826b3b6bfd4ce30dbfc394eaa586e35dcd356fd189 # This is the hash of the tar.gz file not the uncompressed
        dest: Launcher

      # Metadata file for Flatpak repos
      - type: file
        path: com.projectplusgame.project_plus_dolphin_emulator.metainfo.xml

      - type: script
        commands:
          - |
            echo "Setting up Discord rich presence"
            for i in {0..9}; do
              test -S $XDG_RUNTIME_DIR/discord-ipc-$i ||
                ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
            done

            echo "Make directories /var/data/FasterPPlus/Wii (~/.var/app/com.projectplusgame.project_plus_dolphin_emulator/data/FasterPPlus/Wii) if it doesn't exist"
            mkdir -p /var/data/FasterPPlus/Wii

            echo "Make directories /var/config/FasterPPlus/ (~/.var/app/com.projectplusgame.project_plus_dolphin_emulator/config/FasterPPlus) if it doesn't exist"
            mkdir -p /var/config/FasterPPlus

            echo "Copy sd.raw to user data directory (~/.var/app/com.projectplusgame.project_plus_dolphin_emulator/data/FasterPPlus/Wii/sd.raw) if it doesn't already exist"
            cp -n "`dirname $0`"/../share/ishiiruka/sys/Wii/sd.raw /var/data/FasterPPlus/Wii/sd.raw

            echo "Copy Launcher directory to user data directory (~/.var/app/com.projectplusgame.project_plus_dolphin_emulator/data/FasterPPlus/Wii) if it doesn't already exist"
            cp -nr "`dirname $0`"/../share/ishiiruka/sys/Wii/Launcher /var/data/FasterPPlus/Wii

            echo "Copy user Dolphin.ini to user config directory (~/.var/app/com.projectplusgame.project_plus_dolphin_emulator/config/FasterPPlus/Dolphin.ini) if it doesn't already exist"
            cp -n "`dirname $0`"/../share/ishiiruka/user/Config/Dolphin.ini /var/config/FasterPPlus/Dolphin.ini

            ishiiruka "$@"
        dest-filename: ishiiruka-wrapper

    post-install:
      # Install ishiiruka-wrapper script
      - |
        echo "Installing ishiiruka-wrapper in ${FLATPAK_DEST}/bin/"
        install -D -t ${FLATPAK_DEST}/bin/ ishiiruka-wrapper

      # Change exec of desktop file to launch ishiiruka-wrapper instead of ishiiruka
      - |
        echo "Changing exec of /app/share/applications/faster-project-plus.desktop file to launch ishiiruka-wrapper instead of ishiiruka"
        desktop-file-edit --set-key=Exec --set-value='/app/bin/ishiiruka-wrapper' /app/share/applications/faster-project-plus.desktop

      # Install metainfo file in Flatpak
      - |
        echo "Installing com.projectplusgame.project_plus_dolphin_emulator.metainfo.xml in ${FLATPAK_DEST}/share/metainfo/"
        install -Dm644 -t ${FLATPAK_DEST}/share/metainfo/ com.projectplusgame.project_plus_dolphin_emulator.metainfo.xml

      # Move ${FLATPAK_DEST}/bin/Sys to ${FLATPAK_DEST}/share/ishiiruka/sys (only use this without the -DLINUX_LOCAL_DEV=true flag set in config-opts)
      - |
        echo "Moving ${FLATPAK_DEST}/bin/Sys to ${FLATPAK_DEST}/share/ishiiruka/sys"
        mv ${FLATPAK_DEST}/bin/Sys ${FLATPAK_DEST}/share/ishiiruka/sys

      # Extract and move sd.tar.gz to ${FLATPAK_DEST}/share/ishiiruka/sys/Wii
      - |
        echo "Extracting and moving sd.tar.gz to ${FLATPAK_DEST}/share/ishiiruka/sys/Wii"
        tar -xf sd.tar.gz -C ${FLATPAK_DEST}/share/ishiiruka/sys/Wii

      # Move Launcher directory with .dol files and icon to ${FLATPAK_DEST}/share/ishiiruka/sys/Wii
      - |
        echo "Moving Launcher directory to ${FLATPAK_DEST}/share/ishiiruka/sys/Wii"
        mv Launcher ${FLATPAK_DEST}/share/ishiiruka/sys/Wii
