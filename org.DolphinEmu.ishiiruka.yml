app-id: org.DolphinEmu.ishiiruka
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: ishiiruka
rename-desktop-file: ishiiruka.desktop
rename-icon: ishiiruka
finish-args:
  - --device=all
  # the file picker uses portals but the set
  # game directory feature still needs this
  - --filesystem=host:ro
  - --socket=pulseaudio
  - --env=QT_QPA_PLATFORM=xcb
  - --socket=x11
  - --share=network
  - --share=ipc
  # required for the emulated bluetooth adapter feature to work.
  - --allow=bluetooth
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --talk-name=org.freedesktop.ScreenSaver
modules:

  # - name: pango-1.42
  #   sources:
  #   - type: archive
  #     url: https://download.gnome.org/sources/pango/1.42/pango-1.42.4.tar.xz
  #     sha256: 1d2b74cd63e8bd41961f2f8d952355aa0f9be6002b52c8aa7699d9f5da597c9d

  - name: gtk2
    cleanup:
    - "/bin"
    # - "/share/gtk-2.0"
    # - "/share/aclocal"
    - "/share/gtk-doc"
    # - "/lib/pkgconfig"
    # - "/lib/gtk-2.0/include"
    # - "/include"
    # - "*.la"
    x-cpe:
      product: gtk+
    config-opts:
    - "--disable-dependency-tracking"
    - "--disable-gtk-doc-html"
    - "--disable-introspection"
    - "--with-xinput=xfree"
    sources:
    # - type: archive
    #   url: https://download.gnome.org/sources/gtk+/2.24/gtk+-2.24.33.tar.xz
    #   sha256: ac2ac757f5942d318a311a54b0c80b5ef295f299c2a73c632f6bfb1ff49cc6da
    - type: archive
      url: https://download.gnome.org/sources/gtk+/2.24/gtk+-2.24.32.tar.xz
      sha256: b6c8a93ddda5eabe3bfee1eb39636c9a03d2a56c7b62828b359bf197943c582e
    # - type: archive
    #   url: https://download.gnome.org/sources/gtk+/2.4/gtk+-2.4.9.tar.bz2
    #   sha256: d88f79b7bffbc9682a317835b6120dcfb360160a9bb7c6130841232585c30d2c
    # - type: archive
    #   url: https://download.gnome.org/sources/gtk+/2.24/gtk+-2.24.9.tar.xz
    #   sha256: 84204bf24cac739fd979943127e7b29cb46b1017684aa24dce630faa01bcb61d
    # - type: archive
    #   url: https://download.gnome.org/sources/gtk+/2.99/gtk+-2.99.3.tar.bz2
    #   sha256: 03dd37fd89fe0f0cea688cb077192b5ff95325b66d53d724c7511d36b6e90496
    # - type: patch
    #   path: gtk+-2.24-gimp-issue-2828-0001.patch
    # - type: patch
    #   path: gtk+-2.24-gimp-issue-2828-0002.patch
    # - type: patch
    #   path: gtk-2.24-bug795635.patch

  # # needed for the bluetooth passthrough feature to work
  # - name: libusb
  #   config-opts:
  #     - --disable-static
  #   cleanup:
  #     - /include
  #     - /lib/*.la
  #     - /lib/pkgconfig
  #   sources:
  #     - type: archive
  #       url: https://github.com/libusb/libusb/releases/download/v1.0.26/libusb-1.0.26.tar.bz2
  #       sha256: 12ce7a61fc9854d1d2a1ffe095f7b5fac19ddba095c259e6067a46500381b5a5
  #       x-checker-data:
  #         type: anitya
  #         project-id: 1749
  #         stable-only: true
  #         url-template: https://github.com/libusb/libusb/releases/download/v$version/libusb-$version.tar.bz2

  # enables motion controls on non-wii controllers (switch, ps4, etc)
  # requires a udev rule enabling Motion Sensors access
  - name: libevdev
    buildsystem: meson
    config-opts:
      - -Dtests=disabled
      - -Ddocumentation=disabled
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/libevdev/libevdev-1.13.1.tar.xz
        sha256: 06a77bf2ac5c993305882bc1641017f5bec1592d6d1b64787bad492ab34f2f36
        x-checker-data:
          type: anitya
          project-id: 20540
          stable-only: true
          url-template: https://www.freedesktop.org/software/libevdev/libevdev-$version.tar.xz

  # # needed for screensaver inhibition
  # - name: xdg-screensaver-shim
  #   buildsystem: meson
  #   sources:
  #     - type: archive
  #       url: https://github.com/Unrud/xdg-screensaver-shim/archive/0.0.2.tar.gz
  #       sha256: 0ed2a69fe6ee6cbffd2fe16f85116db737f17fb1e79bfb812d893cf15c728399

  - name: ishiiruka
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_ALSA=OFF
      - -DENABLE_SDL=ON
      - -DENABLE_EVDEV=ON
      - -DDISTRIBUTOR=Flathub
    cleanup:
      - /share/man
    post-install:
      - install -D -t ${FLATPAK_DEST}/bin/ ishiiruka
      - install -Dm644 -t ${FLATPAK_DEST}/share/appdata/ org.DolphinEmu.ishiiruka.appdata.xml
      - sed -i -e 's/"2048"/"512"/g' /app/share/icons/hicolor/scalable/apps/ishiiruka.svg
      - desktop-file-edit --set-key=Exec --set-value='/app/bin/ishiiruka'
        /app/share/applications/ishiiruka.desktop
    sources:
      - type: git
        # url: https://github.com/jlambert360/Ishiiruka/archive/81e0a8f8a53f429b341d440ddb2d2b7802b66d52.tar.gz
        url: https://github.com/jlambert360/Ishiiruka.git
        commit: 81e0a8f8a53f429b341d440ddb2d2b7802b66d52
        # x-checker-data:
        #   type: json
        #   url: https://dolphin-emu.org/update/latest/beta
        #   commit-query: .hash
        #   version-query: .shortrev
        #   timestamp-query: .date
        #   is-main-source: true
      # detects whether dolphin is running in a flatpak sandbox
      # and makes it use xdg directories if it is.
      # prevents dolphin from attempting to write conf files
      # in non-writable paths, typically happens when a user
      # has leftover files from a previous non-flatpak install
      # - type: patch
      #   path: detectflatpak.patch
      # version strings must match exactly for online multiplayer
      # - type: patch
      #   path: nodirtyversion.patch
      # Patch hash for netplay
      - type: shell
        commands:
          - |
            echo "Patching tarball..."
            FPPVERSION="2.29"
            COMMITHASH="81e0a8f8a53f429b341d440ddb2d2b7802b66d52"
            sed -i "s|\${GIT_EXECUTABLE} rev-parse HEAD|echo ${COMMITHASH}|g" CMakeLists.txt  # --set scm_rev_str everywhere to actual commit hash when downloaded
            sed -i "s|\${GIT_EXECUTABLE} describe --always --long --dirty|echo FM v$FPPVERSION|g" CMakeLists.txt # ensures compatibility w/ netplay
            sed -i "s|\${GIT_EXECUTABLE} rev-parse --abbrev-ref HEAD|echo HEAD|g" CMakeLists.txt
      # Patch DiscExtractor.h
      - type: shell
        commands:
          - |
            echo "Patching DiscExtractor.h"
            sed -i "s|#include <optional>|#include <optional>\n#include <string>|g" Source/Core/DiscIO/DiscExtractor.h
      # Patch wxWidgets3
      - type: shell
        commands:
          - |
              echo "Patching wxWidgets3"
              sed -i "s| OR NOT X11_Xinerama_FOUND||g" Externals/wxWidgets3/CMakeLists.txt
              sed -i "s|needs Xinerama and|needs|g" Externals/wxWidgets3/CMakeLists.txt
              sed -i "s|\t\t\${X11_Xinerama_LIB}||g" Externals/wxWidgets3/CMakeLists.txt
      # Move wx files into source
      - type: shell
        commands:
          - |
            echo "Moving wx files into source"
            cp Externals/wxWidgets3/include/wx Source/Core/ -r
            cp Externals/wxWidgets3/wx/* Source/Core/wx/








      - type: file
        path: org.DolphinEmu.ishiiruka.appdata.xml
      - type: script
        commands:
          - |
            for i in {0..9}; do
              test -S $XDG_RUNTIME_DIR/discord-ipc-$i ||
                ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
            done
            ishiiruka "$@"
        dest-filename: ishiiruka
